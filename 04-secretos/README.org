* Almacenamiento de parámetros y secretos compartidos
#+begin_quote
[!IMPORTANT]
Utilizaremos la *Landing Zone* para realizar esta práctica.
#+end_quote

Los objetivos de esta práctica son los siguientes:
- Utilizar los servicios de almacenamiento de parámetros (Systems Manager Parameter Store)
- Utilizar los servicios de almacenamiento de secretos (Secrets Manager)
- Acceder a los secretos y parámetros compartidos desde el código de la aplicación mediante el SDK
- Rotar secretos de bases de datos automáticamente

* Crear un secreto en Secrets Manager
Crea un secreto en Secrets Manager con las siguientes características:
- Secret Type- ~Other type of secret~
- Key/value pairs - Crea una única pareja de clave/valor:
  - Key - ~nombrecompleto~
  - Value - Tu nombre y apellidos completo
- Encryption Key - Deja el valor por defecto
  [[./imagenes/02-secret-1.png]]
- Secret name - ~/practica-secretos/TUS_INICIALES/secret1~. Asegúrate de cambiar ~TUS_INICIALES~ por tus iniciales reales.
  [[./imagenes/02-secret-2.png]]
- No actives la rotación automática
  [[./imagenes/02-secret-3.png]]
- En la pantalla de resumen, puedes ver el código de ejemplo para acceder al secreto desde diferentes lenguajes de programación. Podrás consultar de nuevo el código al acceder a la pestaña de detalles del secreto una vez creado
  [[./imagenes/02-secret-4.png]]

* Crear un parámetro en Systems Manager Parameter Store
Crea una parámetro en Systems Manager Parameter Store con las siguientes características:
- Nombre - ~/practica-secretos/TUS_INICIALES/param1~
  Asegúrate de cambiar ~TUS_INICIALES~ por tus iniciales reales.
- Tier - ~Standard~
- Type - ~String~
- Data type - ~text~
- Value - Tu nombre y apellidos completo

[[./imagenes/01-parametro.png]]

* Acceder a secretos y parámetros desde la CLI
** Acceso a parámetros de Parameter Store
Muestra el parámetro a través de la CLI mediante el comando siguiente. Asegúrate de cambiar ~TUS_INICIALES~ por tus iniciales reales.
#+begin_src bash
  aws ssm get-parameter --name /practica-secretos/TUS_INICIALES/param1
#+end_src

** Acceso a secretos de Secrets Manager
Muestra el secreto a través de la CLI mediante el comando siguiente. Asegúrate de cambiar ~TUS_INICIALES~ por tus iniciales reales.
#+begin_src bash
  aws secretsmanager get-secret-value --secret-id /practica-secretos/TUS_INICIALES/secret1
#+end_src

* Acceder a secretos y parámetros desde la aplicación (SDK)
#+begin_quote
[!IMPORTANT]
Para evitar tener que instalar demasiadas dependencias en el equipo local, utilizaremos *CloudShell* para este apartado.
#+end_quote

#+begin_quote
[!IMPORTANT]
Si lo prefieres, puedes utilizar cualquier otro SDK de otro lenguaje de programación (JavaScript, Python,...) en lugar de PHP. Deberás instalar dichos lenguajes y los SDK correspondientes.
#+end_quote

** Instalación de PHP en CloudShell
1. Abre CloudShell en la cuenta de AWS
2. Ejecuta el siguiente comando para instalar PHP, de acuerdo con las instrucciones de la [[https://docs.aws.amazon.com/cloudshell/latest/userguide/vm-specs.html#installing-software][documentación]]:
   #+begin_src bash
     sudo dnf install php
   #+end_src
3. Comprueba la correcta instalación ejecutando el siguiente comando:
   #+begin_src bash
     php --version
   #+end_src

#+begin_quote
[!IMPORTANT]
Los paquetes instalados en CloudShell solo persisten en la sesión activa. Si la sesión de CloudShell se cierra, deberás instalar el paquete otra vez.
#+end_quote

** Instalación del SDK de PHP
Para poder interactuar con servicios de AWS desde lenguajes de programación, es necesario *instalar el SDK* del lenguaje correspondiente. En este caso, instalaremos el SDK de PHP siguiendo las [[https://docs.aws.amazon.com/sdk-for-php/v3/developer-guide/getting-started_installation.html][instrucciones oficiales]].

Por simplicidad, utilizaremos el método de utilizar un [[https://docs.aws.amazon.com/sdk-for-php/v3/developer-guide/getting-started_installation.html#installing-by-using-the-packaged-phar][empaquetado phar]]. Para ello, será necesario [[https://docs.aws.amazon.com/aws-sdk-php/v3/download/aws.phar][descargar el paquete phar]] tal como indican las instrucciones. En *CloudShell*, puedes ejecutar el siguiente comando para descargar el archivo:
#+begin_src bash
  wget https://docs.aws.amazon.com/aws-sdk-php/v3/download/aws.phar
#+end_src

A partir de ahora, puedes hacer referencia a él desde los archivos PHP mediante el siguiente código, ajustando la ruta correspondiente si fuera necesario:
#+begin_src php
  <?php
     require './aws.phar';
  ?>
#+end_src

** Acceso a parámetros de Parameter Store
Crea un fichero PHP en CloudShell con el siguiente código, basado en la [[https://docs.aws.amazon.com/aws-sdk-php/v3/api/api-ssm-2014-11-06.html#getparameter][documentación del SDK de PHP]]:

#+begin_src php
<?php

// Carga del SDK
require 'aws.phar';

// Clases para interactuar con el servicio correspondiente
use Aws\Ssm\SsmClient;
use Aws\Exception\AwsException;

// Crear el cliente de Systems Manager
$client = new SsmClient([
    'region' => 'TU_REGION'
]);

$parameter_name = '/practica-secretos/TUS_INICIALES/param1';

// Llamada a la API para obtener el parámetro
try {
    $result = $client->getParameter([
        'Name' => $parameter_name,
        'WithDecryption' => false,
    ]);
} catch (AwsException $e) {
    throw $e;
}

// El resultado incluye varios campos. Accedemos al que contiene el valor
$param = $result['Parameter']['Value'];

// El código de la aplicación que tenga que trabajar con el parámetro vendría aquí

// Mostrar el resultado
print("$param\n");
#+end_src

Recuerda *sustituir* ~TUS_INICIALES~ por tus iniciales reales y ~TU_REGION~ por la región en la que estés. Comprueba también que el nombre del parámetro es el correcto. Una vez creado el archivo (puedes utilizar el editor ~nano~, por ejemplo), ejecútalo con el intérprete de PHP:

#+begin_src bash
php fichero_parametro.php
#+end_src

Comprueba que se muestra el valor del parámetro en la consola.

#+begin_quote
[!IMPORTANT]
Recuerda que en este caso estamos accediendo al parámetro a través de CloudShell, donde tenemos los permisos del usuario de la consola (administrador, en este caso).

En un *entorno real*, si el código PHP se está ejecutando en algún nodo de computación (máquina EC2, función Lambda, contenedor), deberíamos utilizar un *rol* asociado a dicho nodo de computación que tuviera *permisos de acceso* al parámetro que queremos obtener.
#+end_quote

** Acceso a secretos de Secrets Manager
Crea un fichero PHP en CloudShell con el siguiente código *basado en el código de ejemplo* que hay disponible en la pestaña /Overview/ del secreto creado, dentro de la sección *Sample code*. En él se ha sustituido la carga del paquete de librería (pensada para utilizar el SDK con el gestor de paquetes ~composer~) por la carga del fichero ~.phar~ descargado anteriormente. También se ha eliminado la referencia al perfil, dado que en CloudShell las credenciales son las del usuario con la sesión iniciada en la consola de AWS (no hay fichero =~/.aws/credentials=).

#+begin_quote
[!IMPORTANT]
El código de PHP de ejemplo de la pestaña /Overview/ puede incluir algunos errores, como por ejemplo la ausencia del carácter ~\~ de delimitador de ruta en la carga de librerías. El que se proporciona a continuación funciona correctamente.
#+end_quote

#+begin_src php
<?php

// Carga del SDK
require 'aws.phar';

// Clases para interactuar con el servicio correspondiente
use Aws\SecretsManager\SecretsManagerClient;
use Aws\Exception\AwsException;

// Crear el cliente de Secrets Manager
$client = new SecretsManagerClient([
    'region' => 'TU_REGION'
]);

$secret_name = '/practica-secretos/TUS_INICIALES/secret1';

// Llamada a la API para obtener el secreto
try {
    $result = $client->getSecretValue([
        'SecretId' => $secret_name,
    ]);
} catch (AwsException $e) {
    throw $e;
}

// El resultado incluye varios campos. Accedemos al que contiene el secreto
$secret = $result['SecretString'];


// El código de la aplicación que tenga que trabajar con el secreto vendría aquí

// Mostrar el resultado
print("$secret\n");
#+end_src

Recuerda *sustituir* ~TUS_INICIALES~ por tus iniciales reales y ~TU_REGION~ por la región en la que estés. Comprueba también que el nombre del secreto es el correcto. Una vez creado el archivo (puedes utilizar el editor ~nano~, por ejemplo), ejecútalo con el intérprete de PHP:

#+begin_src bash
php fichero_secretos.php
#+end_src

Comprueba que se muestra el secreto en la consola.

#+begin_quote
[!IMPORTANT]
Recuerda que en este caso estamos accediendo al secreto a través de CloudShell, donde tenemos los permisos del usuario de la consola (administrador, en este caso).

En un *entorno real*, si el código PHP se está ejecutando en algún nodo de computación (máquina EC2, función Lambda, contenedor), deberíamos utilizar un *rol* asociado a dicho nodo de computación que tuviera *permisos de acceso* al secreto que queremos obtener.
#+end_quote

* Aplicación real en Beanstalk
** Variables de entorno
** Secretos en variables de entorno
En Beanstalk, se pueden guardar secretos de secrets manager en env variables, pero solo se sincronizan al actualizar el entorno o reiniciar instancias.

1. Cargar secretos a env variables. Rotar secreto. Ver que no cambia. Refrescar entorno y ver que cambia. Todo ello, simplemente mostrando en PHP.
2. Cargar secretos desde fichero ~.ebextensions~.
** Secretos desde el SDK


* Entrega
Documenta la realización de la práctica explicando los pasos seguidos. Incluye las *capturas de pantalla* necesarias. Recuerda mostrar tus datos personales (nombre y apellidos, iniciales) en aquellos apartados donde se indique.

* Limpieza
Al finalizar, *elimina* los recursos creados en la práctica.
