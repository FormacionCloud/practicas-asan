* Acceso a base de datos RDS desde Lambda
#+begin_quote
[!IMPORTANT]
Utilizaremos la *Landing Zone* para realizar esta práctica.
#+end_quote

Los objetivos de esta práctica son los siguientes:
- Configurar una base de datos RDS con un proxy de conexiones
- Crear funciones Lambda con acceso a bases de datos relacionales
- Configurar funciones lambda para acceder a recursos dentro de la VPC
- Utilizar variables de entorno para independizar el código de la configuración de entornos locales de desarrollo y producción

* Diagrama de la arquitectura 
El objetivo de esta práctica es crear y desplegar una función Lambda que añada registros y realice consultas en una base de datos.

Simularemos un entorno de trabajo real, en el que utilizaremos el *equipo local* como equipo de desarrollo para *crear* y *testear* el código con una *base de datos local* de pruebas. Una vez comprobado el correcto funcionamiento en el equipo local, realizaremos el *despliegue de la aplicación* en el servicio *Lambda*, que utilizará una *base de datos RDS* desplegada en AWS.

*Para evitar tener que modificar el código de la aplicación* con las referencias a los *datos de conexión* de las bases de datos *local* y en *producción*, utilizaremos *variables de entorno*: el código será el mismo, pero los datos de conexión dependerán de la infraestructura donde se esté ejecutando.

El diagrama de arquitectura es el siguiente:
#+begin_src plantuml :file ./imagenes/00-arquitectura.png :exports results
  @startuml VPC
  !define AWSPuml https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v19.0/dist
  !include AWSPuml/AWSCommon.puml
  !include AWSPuml/AWSSimplified.puml
  !include AWSPuml/General/Client.puml
  !include AWSPuml/Compute/LambdaLambdaFunction.puml
  !include AWSPuml/Database/Database.puml
  !include AWSPuml/Database/RDSProxyInstance.puml
  !include AWSPuml/Database/AuroraAmazonRDSInstance.puml
  !include AWSPuml/Groups/Generic.puml
  !include AWSPuml/Groups/CorporateDataCenter.puml
  !include AWSPuml/Groups/AWSCloud.puml
  !include AWSPuml/Groups/SecurityGroup.puml
  !include AWSPuml/Groups/VPC.puml
  !include AWSPuml/General/SourceCode.puml
  !include AWSPuml/General/Document.puml
  !include AWSPuml/NetworkingContentDelivery/VPCElasticNetworkInterface.puml

  left to right direction

  CorporateDataCenterGroup(local, "Equipo local") {
    Document(envvars1, "Variables de entorno locales", "")
    Client(client, "Entorno de desarrollo", "")
    Database(db, "Base de datos local", "")
    SourceCode(code1, "Código", "")
    client ---> code1 : "Ejecuta"
    code1 ---> db : "Accede a"
    envvars1 <-[dotted]- code1 : "Lee"
  }

  AWSCloudGroup(cloud,"Cuenta AWS alumn@") {
    Document(envvars2, "Variables de entorno en Lambda", "")
    LambdaLambdaFunction(lambda, "Función lambda", "")
    VPCGroup(vpc, "VPC") {
      SecurityGroupGroup(lambdaENIsg, "Lambda SG") {
        VPCElasticNetworkInterface(lambdaENI, "Lambda ENI", "")
      }
      SecurityGroupGroup(proxysg, "Proxy SG") {
        RDSProxyInstance(proxyRDS, "Proxy RDS", "")
      }
      SecurityGroupGroup(rdssg, "RDS SG") {
        AuroraAmazonRDSInstance(dbrds, "Base de datos RDS", "")
      }
    }
    SourceCode(code2, "Código", "")
    lambda ---> code2 : "Ejecuta"
    code2 ---> lambdaENI : "A través de"
    lambdaENI ---> proxyRDS : "Accede a"
    proxyRDS -> dbrds : ""
    envvars2 <-[dotted]- code2 : "Lee"
  }

  code1 <-[#green,dotted]> code2 : "Mismo código"

  @enduml
#+end_src

#+RESULTS:
[[file:./imagenes/00-arquitectura.png]]


#+begin_quote
[!NOTE]
Esta práctica está basada en el tutorial oficial [[https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/rds-lambda-tutorial.html][Tutorial: Using a Lambda function to access an Amazon RDS database]].
#+end_quote

* Realización de la práctica 
** Prueba del código en entorno local
#+begin_quote
[!NOTE]
Para hacer la prueba en entorno local, se supone que tienes correctamente configurado el editor *Visual Studio Code* junto con *Python*. En el módulo de base de datos tienes un vídeo en el que se detalla cómo instalar todo lo necesario.
#+end_quote

#+begin_quote
[!NOTE]
Es necesario disponer de una instalación de MySQL en el equipo local. También puedes utilizar cualquier otra base de datos de tipo MySQL a la que tengas acceso. Debes tener creada una *base de datos* inicial.
#+end_quote

En primer lugar, clona el repositorio si no lo has hecho ya. Accede a la carpeta ~06-lambda/src~ y ejecuta el siguiente comando desde Visual Studio Code:
#+begin_src bash
  pip install --target ./ pymysql
#+end_src

Este comando instala las dependencias del proyecto en el directorio actual. Si todo ha ido bien, dentro de la carpeta ~src~ verás dos carpetas adicionales, que contienen las librerías necesarias para acceder a MySQL desde el código:
[[./imagenes/05-local.png]]

A continuación, *inspecciona el código* del fichero ~lambda.py~. Observa que utiliza *variables de entorno* para obtener los *datos de conexión de la base de datos* a la que se va a conectar.

Llega el momento de *probar el código*. Para ello, es necesario configurar *variables de entorno locales* antes de ejecutarlo. En *Windows*, ejecuta el siguiente código, *sustituyendo los valores por los datos de conexión de tu servidor MySQL*:
#+begin_src bash
  set DB_NAME=NOMBRE_BASE_DATOS
  set RDS_PROXY_HOST=localhost
  set USER_NAME=USUARIO_BASE_DATOS
  set PASSWORD=PASS_BASE_DATOS
#+end_src

O en *Linux* (o /Windows Subsystem for Linux/):
#+begin_src bash
  export DB_NAME=NOMBRE_BASE_DATOS
  export RDS_PROXY_HOST=localhost
  export USER_NAME=USUARIO_BASE_DATOS
  export PASSWORD=PASS_BASE_DATOS
#+end_src

A continuación, *ejecuta el siguiente* comando en un terminal de Visual Studio Code:
#+begin_src bash
  python lambda.py '{"CustID": "13339", "Name": "Mi Nombre y Apellido"}'
#+end_src

Puedes crear más registros cambiando la clave ~CustID~. Comprueba en tu base de datos que se han creado los registros correspondientes.

** Creación de la base de datos RDS
#+begin_quote
[!NOTE]
Para realizar este apartado, se asume que sabes crear una base de datos en Amazon RDS. Si tienes alguna duda, utiliza el foro de clase.
#+end_quote

Crea una base de datos *MySql* en una *subred privada* de una *VPC*. Utiliza el asistente *Full Configuration*, con plantilla *Free tier* y despliegue de tipo *Single AZ*. Asegúrate de configurar los siguientes *parámetros*:
- *Master username* - ~admin-TUS_INICIALES~, cambiando ~TUS_INICIALES~ por tus iniciales reales
- *Master password* y *Confirm master password* - Un password de tu elección
- *Tipo de instancia* - ~db.t4g.micro~
- *Grupo de seguridad* - Un grupo de seguridad que se utilizará para permitir el acceso desde la función Lambda. Puedes utilizar uno que tengas ya existente o crear uno nuevo
- *Additional configuration / Initial database name* - Utiliza el nombre ~lambda-db~. Asegúrate de *apuntar este dato* para utilizarlo en la configuración de las variables de entorno de la función Lambda

El resto de parámetros puedes dejarlos por defecto, no necesitaremos ninguna configuración especial.

** Creación del Proxy RDS
Crea un proxy RDS para la base de datos. Es una buena idea utilizar un proxy para el acceso desde funciones Lambda, porque cada una de las ejecuciones utilizará una conexión diferente, pudiendo agotar las de la base de datos. Para ello, accede a la consola de RDS y crea un proxy para la base de datos creada en el apartado anterior:
[[./imagenes/03-proxy.png]]

[[./imagenes/03-proxy-2.png]]

El proxy necesita crear un secreto en Secrets Manager para sincronizar el password. Para ello, crea un secreto nuevo para utilizar con base de datos. Utiliza el nombre de usuario y password de la base de datos:
[[./imagenes/03-proxy-3.png]]

[[./imagenes/03-proxy-4.png]]

La creación del proxy tarda unos minutos. Puedes seguir con el siguiente apartado mientras se termina de crear. *Apunta la URL del endpoint* para utilizarlo más adelante.
[[./imagenes/03-proxy-5.png]]

** Creación de la función Lambda
Crea una función lambda desde cero, con motor *Python 3.14* y con un *rol de ejecución nuevo*:
[[./imagenes/02-lambda.png]]

** Modificación del rol de ejecución de la función Lambda
Para asociar la función lambda a una VPC, es necesario que el *rol de ejecución* de la función Lambda disponga de los *permisos necesarios*. Para ello, es necesario añadir la política gestionada ~AWSLambdaVPCAccessExecutionRole~ al rol de ejecución de la función Lambda.

#+begin_quote
[!IMPORTANT]
Ese permiso se añade *automáticamente* al rol de ejecución si se asocia la función lambda a la VPC *a través de la consola*. Si por el contrario la acción se realiza a través de la *CLI*, entonces sí que es necesario modificar el rol *manualmente*.
#+end_quote

#+begin_quote
[!NOTE]
Esos permisos son necesarios únicamente para realizar la asociación de la función a la VPC y crear el *interfaz de red virtual* privado que utilizará la función Lambda. Una vez terminada esa acción, es posible quitar dichos permisos si el código de la función no necesita realizar acciones adicionales sobre la VPC. Para más información, consultar la [[https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html#configuration-vpc-attaching][documentación]].
#+end_quote

Dado que vamos a realizar esta acción desde la consola, no es necesario hacer nada en este apartado.

** Conexión de la función a la VPC
Modifica la configuración de la función para conectar la función Lambda a la VPC donde hayas creado la base de datos de RDS:
[[./imagenes/01-vpc.png]]

Asegúrate de lo siguiente:
- Elegir la misma *VPC* usada para desplegar la base de datos
- Elegir una *subred*, en principio y por simplicidad puedes utilizar la misma subred que utiliza la base de datos
- Utilizar un *grupo de seguridad* que permita el acceso al grupo de seguridad de la base de datos. De nuevo, aquí puedes utilizar un grupo de seguridad existente o crear uno nuevo

[[./imagenes/01-grupo-seguridad.png]]

** Actualización del código de la función desde VS Code
Procedemos ahora a *modificar el código de la función lambda*. Para ello, *comprime en formato ZIP* el *contenido de la carpeta* ~src~. El objetivo es crear un fichero ZIP en cuyo interior se encuentre el fichero ~lambda.py~ y las *carpetas de librerías* en la raíz del fichero ZIP:
[[./imagenes/06-codigo-zip.png]]

Accede a la función lambda en la consola de AWS y sube el fichero ZIP:
[[./imagenes/06-codigo-zip-2.png]]

Una vez actualizado, puedes *editarlo desde Visual Studio Code*:
[[./imagenes/06-vscode.png]]

Verás que el código se descarga a una *carpeta temporal de tu equipo* y que dicha carpeta es abierta por Visual Studio Code. Si haces algún cambio en el fichero, VSCode *preguntará si quieres actualizar* el código en Lambda:
[[./imagenes/06-vscode-2.png]]

Si lo deseas, puedes hacer algún pequeño cambio (en algún log) para ver cómo se actualizan los cambios a la función lambda.

** Creación de variables de entorno
Modifica la configuración de la función lambda para añadir las siguientes *variables de entorno* con los valores correspondientes a la configuración de la *base de datos y el proxy RDS*:
[[./imagenes/04-envvars.png]]

Recuerda que el código de la función lambda utiliza *variables de entorno* para saber los datos de conexión a la base de datos que necesita utilizar.

#+begin_quote
[!NOTE]
Para almacenar datos de configuración o secretos es posible utilizar también *SSM Parameter Store* o *Secrets Manager* en lugar de variables de entorno. No obstante, si se utiliza alguno de esos servicios, es necesario *modificar el código de la función* para obtener dichos secretos mediante el SDK. Cada uno de esos enfoques tiene sus ventajas e inconvenientes.
#+end_quote

** Prueba de la función Lambda
Ya tenemos todo listo para probar la función. Para ello, en primer lugar iremos a la consola de AWS y crearemos un evento de test:
[[./imagenes/07-test.png]]

Puedes utilizar el siguiente código:
#+begin_src json
  {
    "CustID": "339921",
    "Name": "Test Pedro Prieto"
  }
#+end_src

Puedes probar a crear varios registros cambiando el valor del campo ~CustID~.

* Entrega
Documenta la realización de la práctica explicando los pasos seguidos. Incluye las *capturas de pantalla* necesarias. Recuerda mostrar tus datos personales (nombre y apellidos, iniciales) en aquellos apartados donde se indique.

* Limpieza
Elimina los recursos utilizados en la práctica: *proxy RDS* y *base de datos RDS*. La función lambda no es necesario que la elimines, dado que no tiene coste a no ser que se supere el millón de ejecuciones.
